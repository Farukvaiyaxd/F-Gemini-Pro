<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat with Gemini API</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        :root {
            --light-bg: #F9FAFB;
            --light-sidebar-bg: #FFFFFF;
            --light-header-bg: #FFFFFF;
            --light-text-primary: #111827;
            --light-text-secondary: #6B7280;
            --light-border-color: #E5E7EB;
            --accent-color: #3B82F6;
            --user-msg-bg: #DBEAFE;
            --bot-msg-bg: #F3F4F6;
            --danger-color: #EF4444;

            --dark-bg: #111827;
            --dark-sidebar-bg: #1F2937;
            --dark-header-bg: #1F2937;
            --dark-text-primary: #F9FAFB;
            --dark-text-secondary: #9CA3AF;
            --dark-border-color: #374151;
            --dark-user-msg-bg: #374151;
            --dark-bot-msg-bg: #1F2937;
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--light-bg);
            color: var(--light-text-primary);
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-mode {
            background-color: var(--dark-bg);
            color: var(--dark-text-primary);
        }

        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* --- SIDEBAR STYLES --- */
        .sidebar {
            width: 260px;
            background-color: var(--light-sidebar-bg);
            border-right: 1px solid var(--light-border-color);
            display: flex;
            flex-direction: column;
            padding: 16px;
            transition: background-color 0.3s, border-color 0.3s, transform 0.3s ease-in-out;
            flex-shrink: 0;
            z-index: 1001;
        }
        
        body.dark-mode .sidebar {
            background-color: var(--dark-sidebar-bg);
            border-right: 1px solid var(--dark-border-color);
        }
        
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .sidebar-header h3 { font-size: 18px; }
        #close-sidebar-btn { display: none; background: none; border: none; font-size: 20px; cursor: pointer; color: var(--light-text-secondary); }
        body.dark-mode #close-sidebar-btn { color: var(--dark-text-secondary); }

        .new-chat-btn { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 12px; border: 1px solid var(--light-border-color); border-radius: 8px; background-color: transparent; color: var(--light-text-primary); font-size: 15px; font-weight: 500; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
        body.dark-mode .new-chat-btn { border-color: var(--dark-border-color); color: var(--dark-text-primary); }
        .new-chat-btn:hover { background-color: var(--light-border-color); }
        body.dark-mode .new-chat-btn:hover { background-color: var(--dark-border-color); }

        .chat-history { flex-grow: 1; margin-top: 16px; overflow-y: auto; }
        .chat-history h3 { font-size: 13px; color: var(--light-text-secondary); margin-bottom: 12px; text-transform: uppercase; }
        body.dark-mode .chat-history h3 { color: var(--dark-text-secondary); }
        .chat-history ul { list-style: none; padding: 0; margin: 0; }
        .chat-history li { display:flex; align-items:center; justify-content:space-between; margin-bottom:4px; }
        .history-item { display:flex; align-items:center; gap:12px; padding: 8px 10px; border-radius:8px; color: var(--light-text-primary); text-decoration:none; font-size:14px; cursor:pointer; flex:1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border: 1px solid transparent; }
        .history-item:hover { background-color: var(--bot-msg-bg); }
        body.dark-mode .history-item { color: var(--dark-text-primary); }
        body.dark-mode .history-item:hover { background-color: var(--dark-bot-msg-bg); }
        .history-actions { display:flex; flex-shrink:0; }
        .history-actions button { border:none; background:transparent; cursor:pointer; padding:6px; border-radius:6px; font-size:14px; color:var(--light-text-secondary); }
        .history-actions button:hover { background-color: rgba(0,0,0,0.1); }
        body.dark-mode .history-actions button { color: var(--dark-text-secondary); }
        body.dark-mode .history-actions button:hover { background-color: rgba(255,255,255,0.1); }
        
        .user-profile { border-top: 1px solid var(--light-border-color); padding-top: 16px; }
        body.dark-mode .user-profile { border-top: 1px solid var(--dark-border-color); }
        .user-profile a { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 8px; color: var(--light-text-primary); text-decoration: none; font-size: 15px; }
        body.dark-mode .user-profile a { color: var(--dark-text-primary); }
        .user-profile a:hover { background-color: var(--bot-msg-bg); }
        body.dark-mode .user-profile a:hover { background-color: var(--dark-bot-msg-bg); }
        .user-profile img { width: 32px; height: 32px; border-radius: 50%; }

        /* --- CHAT AREA STYLES --- */
        .chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .chat-header {
            padding: 12px 24px;
            border-bottom: 1px solid var(--light-border-color);
            background-color: var(--light-header-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        body.dark-mode .chat-header {
            background-color: var(--dark-header-bg);
            border-bottom: 1px solid var(--dark-border-color);
        }
        
        .header-left { display: flex; align-items: center; gap: 16px; }
        #menu-toggle-btn { display: none; background: none; border: none; font-size: 20px; cursor: pointer; color: var(--light-text-secondary); }
        body.dark-mode #menu-toggle-btn { color: var(--dark-text-secondary); }

        #theme-toggle-button {
            background: none; border: none; cursor: pointer;
            font-size: 22px; color: var(--light-text-secondary);
        }
        body.dark-mode #theme-toggle-button { color: var(--dark-text-secondary); }

        .message-list {
            flex-grow: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        .message-wrapper {
            max-width: 95%;
        }

        .user-message {
            display: flex;
            gap: 16px;
            align-items: flex-start;
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        
        .bot-message .message-icon {
            float: left;
            margin-right: 16px;
        }
        
        .message-icon {
            width: 36px; height: 36px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; flex-shrink: 0;
            background-color: var(--light-border-color);
        }
        body.dark-mode .message-icon { background-color: var(--dark-border-color); }
        
        .message-content {
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.6;
            overflow-wrap: break-word;
            width: fit-content;
            overflow: auto; /* Fix for float wrapping */
        }

        .user-message .message-content {
            background-color: var(--user-msg-bg);
            color: #1E40AF;
        }
        body.dark-mode .user-message .message-content {
            background-color: var(--dark-user-msg-bg);
            color: var(--dark-text-primary);
        }

        .bot-message .message-content {
            background-color: var(--bot-msg-bg);
            border: 1px solid var(--light-border-color);
        }
        body.dark-mode .bot-message .message-content {
            background-color: var(--dark-bot-msg-bg);
            border: 1px solid var(--dark-border-color);
        }
        
        .message-content p:not(:last-child) {
             margin-bottom: 1em;
        }

        .message-input-container {
            padding: 16px 24px;
            border-top: 1px solid var(--light-border-color);
            flex-shrink: 0;
        }
        body.dark-mode .message-input-container {
            border-top: 1px solid var(--dark-border-color);
        }
        
        .message-input-form {
            display: flex; align-items: center; gap: 16px;
            background-color: var(--light-header-bg); padding: 8px 16px;
            border-radius: 12px; border: 1px solid var(--light-border-color);
        }
        body.dark-mode .message-input-form {
            background-color: var(--dark-sidebar-bg);
            border: 1px solid var(--dark-border-color);
        }

        #message-input {
            flex-grow: 1; border: none; outline: none; background: transparent;
            font-size: 16px; padding: 8px; color: var(--light-text-primary);
            resize: none; max-height: 100px;
        }
        body.dark-mode #message-input { color: var(--dark-text-primary); }

        #send-button {
            background-color: var(--accent-color); color: white; border: none;
            width: 36px; height: 36px; border-radius: 8px; font-size: 16px;
            cursor: pointer; transition: background-color 0.2s;
        }
        #send-button.stop-button {
            background-color: var(--danger-color);
        }
        #send-button:disabled { background-color: var(--light-text-secondary); cursor: not-allowed; }
        #send-button:hover:not(:disabled) { background-color: var(--accent-color-hover); }
        #send-button.stop-button:hover {
            background-color: #B91C1C;
        }

        /* Code Block Styling */
        .message-content pre {
            background-color: #161a22; color: #d4d4d4; padding: 0;
            border-radius: 8px; border: 1px solid var(--dark-border-color);
            position: relative; overflow: hidden; margin-top: 1em;
        }

        .code-block-header {
            display: flex; justify-content: space-between; align-items: center;
            background-color: #374151; padding: 6px 16px;
            border-bottom: 1px solid var(--dark-border-color);
        }

        .language-name {
            font-size: 13px; text-transform: capitalize; font-weight: 500;
            color: var(--dark-text-secondary);
        }
        
        .copy-code-btn {
            background-color: transparent; color: var(--dark-text-secondary);
            border: none; border-radius: 6px; padding: 4px 10px; font-size: 12px;
            cursor: pointer; transition: background-color 0.2s;
        }
        .copy-code-btn:hover { background-color: var(--dark-border-color); }
        
        .message-content pre code {
            display: block; padding: 16px; overflow-x: auto; white-space: pre;
        }
        
        /* Typing indicator */
        .typing-dot {
            width: 8px; height: 8px; margin: 0 2px;
            background-color: var(--light-text-secondary);
            border-radius: 50%; display: inline-block;
            animation: typing-bounce 1.4s infinite ease-in-out both;
        }
        body.dark-mode .typing-dot { background-color: var(--dark-text-secondary); }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing-bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* MODEL SELECTOR STYLES */
        .custom-select-container { position: relative; }
        .selected-model-display { padding: 6px 12px; border: 1px solid var(--light-border-color); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s ease; }
        body.dark-mode .selected-model-display { border: 1px solid var(--dark-border-color); }
        .selected-model-display:hover { background-color: var(--light-border-color); }
        body.dark-mode .selected-model-display:hover { background-color: var(--dark-border-color); }
        .model-display-text .model-name { font-size: 14px; font-weight: 500; }
        .selected-model-display .model-chevron { transition: transform 0.2s ease; font-size: 16px; }
        .model-options-list { position: absolute; top: calc(100% + 5px); left: 0; width: auto; min-width: 250px; background-color: var(--light-header-bg); border: 1px solid var(--light-border-color); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1000; overflow: hidden; visibility: hidden; opacity: 0; transform: translateY(-10px); transition: all 0.2s ease-out; }
        body.dark-mode .model-options-list { background-color: var(--dark-header-bg); border: 1px solid var(--dark-border-color); }
        .model-options-list.open { visibility: visible; opacity: 1; transform: translateY(0); }
        .model-option { padding: 12px 16px; cursor: pointer; transition: background-color 0.2s; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .model-option:hover { background-color: var(--bot-msg-bg); }
        body.dark-mode .model-option:hover { background-color: var(--dark-bot-msg-bg); }
        .model-option.selected { font-weight: 600; color: var(--accent-color); }
        .model-option.selected .fa-check { margin-left: auto; }


        /* Responsive Sidebar */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); z-index: 1000;
            display: none;
        }
        .overlay.active { display: block; }
        
        @media (max-width: 768px) {
            .sidebar {
                position: absolute; top: 0; left: 0; height: 100%;
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
                box-shadow: 4px 0 15px rgba(0,0,0,0.1);
            }
            #menu-toggle-btn, #close-sidebar-btn { display: block; }
        }
        
        /* CUSTOM CONFIRM MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex; align-items: center; justify-content: center;
            z-index: 2000;
            opacity: 0; visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }
        .modal-overlay.visible {
            opacity: 1; visibility: visible;
        }
        .modal-content-confirm {
            background: var(--light-sidebar-bg);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        body.dark-mode .modal-content-confirm {
             background: var(--dark-sidebar-bg);
             border: 1px solid var(--dark-border-color);
        }
        #custom-confirm-msg {
            font-size: 16px;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
        }
        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .modal-button.cancel {
            background-color: var(--light-border-color);
            color: var(--light-text-primary);
        }
        body.dark-mode .modal-button.cancel {
            background-color: var(--dark-border-color);
            color: var(--dark-text-primary);
        }
        .modal-button.confirm {
            background-color: var(--danger-color);
            color: white;
        }

    </style>
</head>
<body class="dark-mode">
    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>Menu</h3>
                <button id="close-sidebar-btn"><i class="fa-solid fa-times"></i></button>
            </div>
            <button class="new-chat-btn">
                <i class="fa-solid fa-plus"></i> New Chat
            </button>
            <div class="chat-history">
                <h3>History</h3>
                <ul></ul>
            </div>
            <div class="user-profile">
                <a href="#">
                    <img src="https://via.placeholder.com/32" alt="User Avatar">
                    <span>User Profile</span>
                </a>
            </div>
        </aside>

        <main class="chat-area">
            <header class="chat-header">
                <div class="header-left">
                    <button id="menu-toggle-btn"><i class="fa-solid fa-bars"></i></button>
                    <h2>AI Chat</h2>
                    <div id="custom-model-selector" class="custom-select-container"></div>
                </div>
                <button id="theme-toggle-button" title="Toggle theme">
                    <i class="fa-solid fa-sun"></i>
                </button>
            </header>
            <div class="message-list" id="chat-window"></div>
            <div class="message-input-container">
                <form class="message-input-form">
                    <textarea id="message-input" placeholder="Type your message here..." rows="1"></textarea>
                    <button type="submit" id="send-button" disabled title="Send message">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </main>
    </div>
    
    <div class="overlay" id="overlay"></div>
    <div id="custom-confirm-overlay" class="modal-overlay">
        <div class="modal-content-confirm">
            <p id="custom-confirm-msg"></p>
            <div class="modal-actions">
                <button id="confirm-btn-cancel" class="modal-button cancel">Cancel</button>
                <button id="confirm-btn-ok" class="modal-button confirm">Delete</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const chatWindow = document.getElementById('chat-window');
    const themeToggleButton = document.getElementById('theme-toggle-button');
    const themeIcon = themeToggleButton.querySelector('i');
    const messageForm = document.querySelector('.message-input-form');
    const customModelSelector = document.getElementById('custom-model-selector');

    // --- SIDEBAR & HISTORY ELEMENTS ---
    const sidebar = document.getElementById('sidebar');
    const menuToggleButton = document.getElementById('menu-toggle-btn');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');
    const overlay = document.getElementById('overlay');
    const newChatBtn = document.querySelector('.new-chat-btn');
    const historyList = document.querySelector('.chat-history ul');

    let allChats = {};
    let activeChatId = null;
    let selectedModelId = '';
    let isBotGenerating = false;
    let generationController = null;

    // UPDATED MODEL LIST
    const preferredModels = [
        { id: 'gemini-2.5-flash-lite', name: 'Gemini 2.5 Flash Lite' },
        { id: 'gemini-2.5-flash', name: 'Gemini 2.5 Flash' },
        { id: 'gemini-2.5-pro', name: 'Gemini 2.5 Pro' },
        { id: 'gemini-2.0-flash', name: 'Gemini 2.0 Flash' },
        { id: 'gemini-1.5-flash', name: 'Gemini 1.5 Flash' },
        { id: 'gemini-1.5-pro', name: 'Gemini 1.5 Pro' },
        { id: 'gemini-1.5-flash-8b', name: 'Gemini 1.5 Flash 8B' },
    ];

    // --- CUSTOM CONFIRM MODAL LOGIC ---
    const confirmOverlay = document.getElementById('custom-confirm-overlay');
    const confirmMsg = document.getElementById('custom-confirm-msg');
    const confirmOkBtn = document.getElementById('confirm-btn-ok');
    const confirmCancelBtn = document.getElementById('confirm-btn-cancel');

    function customConfirm(message) {
        return new Promise(resolve => {
            confirmMsg.textContent = message;
            confirmOverlay.classList.add('visible');

            const onOk = () => {
                confirmOverlay.classList.remove('visible');
                resolve(true);
                cleanup();
            };

            const onCancel = () => {
                confirmOverlay.classList.remove('visible');
                resolve(false);
                cleanup();
            };
            
            const cleanup = () => {
                confirmOkBtn.removeEventListener('click', onOk);
                confirmCancelBtn.removeEventListener('click', onCancel);
            };

            confirmOkBtn.addEventListener('click', onOk);
            confirmCancelBtn.addEventListener('click', onCancel);
        });
    }


    // --- SIDEBAR & HISTORY LOGIC ---
    function toggleSidebar() {
        sidebar.classList.toggle('open');
        overlay.classList.toggle('active');
    }
    [menuToggleButton, closeSidebarBtn, overlay].forEach(el => el.addEventListener('click', toggleSidebar));

    function loadChatsFromStorage() {
        allChats = JSON.parse(localStorage.getItem('all-chats')) || {};
    }

    function saveChatsToStorage() {
        localStorage.setItem('all-chats', JSON.stringify(allChats));
    }

    function renderHistorySidebar() {
        historyList.innerHTML = '';
        const sortedChats = Object.values(allChats).sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0));
        sortedChats.forEach(chat => {
            const li = document.createElement('li');
            
            // *** CHANGE MADE HERE: Using 'div' instead of 'a' to prevent long-press link behavior ***
            const itemContainer = document.createElement('div');
            itemContainer.className = 'history-item';
            itemContainer.dataset.chatId = chat.id;
            itemContainer.innerHTML = `<i class="fa-regular fa-message"></i> <span style="flex-grow: 1; overflow: hidden; text-overflow: ellipsis;">${chat.title}</span>`;
            itemContainer.onclick = (e) => {
                e.preventDefault();
                loadChat(chat.id);
            };
            
            const actions = document.createElement('div');
            actions.className = 'history-actions';
            
            const deleteBtn = document.createElement('button');
            deleteBtn.title = 'Delete';
            deleteBtn.innerHTML = `<i class="fa-solid fa-trash"></i>`;
            deleteBtn.onclick = async (e) => { 
                e.stopPropagation();
                const confirmed = await customConfirm(`আপনি কি নিশ্চিতভাবে "${chat.title}" চ্যাটটি মুছে ফেলতে চান?`);
                if (confirmed) {
                    delete allChats[chat.id];
                    saveChatsToStorage();
                    if (activeChatId === chat.id) {
                        startNewChat();
                    }
                    renderHistorySidebar();
                }
            };
            
            actions.appendChild(deleteBtn);
            li.append(itemContainer, actions);
            historyList.appendChild(li);
        });
    }

    function loadChat(chatId) {
        if (!allChats[chatId]) return;
        activeChatId = chatId;
        chatWindow.innerHTML = '';
        allChats[chatId].messages.forEach(msg => {
            appendMessage(msg.text, msg.role, false);
        });
        setTimeout(() => { chatWindow.scrollTop = chatWindow.scrollHeight; }, 0);
        if (sidebar.classList.contains('open')) { toggleSidebar(); }
    }

    function startNewChat() {
        activeChatId = null;
        chatWindow.innerHTML = '';
        appendMessage("Hello! How can I assist you today?", 'bot', false);
    }
    newChatBtn.addEventListener('click', startNewChat);

    // --- THEME ---
    function applyTheme(theme) {
        if (theme === 'dark') {
            document.body.classList.add('dark-mode');
            themeIcon.classList.replace('fa-sun', 'fa-moon');
        } else {
            document.body.classList.remove('dark-mode');
            themeIcon.classList.replace('fa-moon', 'fa-sun');
        }
    }
    themeToggleButton.addEventListener('click', () => {
        const newTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
        localStorage.setItem('chat-theme', newTheme);
        applyTheme(newTheme);
    });
    
    // --- MODEL SELECTOR ---
    function createCustomDropdown() {
        const selectedDisplay = document.createElement('div');
        selectedDisplay.className = 'selected-model-display';
        const modelDisplayText = document.createElement('span');
        modelDisplayText.className = 'model-display-text';
        const chevron = document.createElement('i');
        chevron.className = 'fa-solid fa-chevron-down model-chevron';
        selectedDisplay.append(modelDisplayText, chevron);

        const optionsList = document.createElement('div');
        optionsList.className = 'model-options-list';

        function setModelDisplay(modelName) {
            modelDisplayText.innerHTML = `<span class="model-name">${modelName}</span>`;
        }

        function updateSelectedOption() {
            optionsList.querySelectorAll('.model-option').forEach(opt => {
                const checkIcon = opt.querySelector('.fa-check');
                if (opt.dataset.id === selectedModelId) {
                    opt.classList.add('selected');
                    if (!checkIcon) opt.innerHTML += ' <i class="fa-solid fa-check"></i>';
                } else {
                    opt.classList.remove('selected');
                    checkIcon?.remove();
                }
            });
        }

        preferredModels.forEach(model => {
            const option = document.createElement('div');
            option.className = 'model-option';
            option.dataset.id = model.id;
            option.innerHTML = `<span>${model.name}</span>`;
            option.addEventListener('click', (e) => {
                e.stopPropagation();
                selectedModelId = model.id;
                setModelDisplay(model.name);
                updateSelectedOption();
                optionsList.classList.remove('open');
                chevron.style.transform = 'rotate(0deg)';
            });
            optionsList.appendChild(option);
        });
        
        customModelSelector.append(selectedDisplay, optionsList);
        
        if (preferredModels.length > 0) {
            selectedModelId = preferredModels[0].id;
            setModelDisplay(preferredModels[0].name);
            updateSelectedOption();
        }

        selectedDisplay.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = optionsList.classList.toggle('open');
            chevron.style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)';
        });
        document.addEventListener('click', () => {
            if (optionsList.classList.contains('open')) {
                optionsList.classList.remove('open');
                chevron.style.transform = 'rotate(0deg)';
            }
        });
    }

    // --- INPUT HANDLING ---
    function resetSendButton() {
        isBotGenerating = false;
        generationController = null;
        sendButton.innerHTML = '<i class="fa-solid fa-paper-plane"></i>';
        sendButton.classList.remove('stop-button');
        sendButton.disabled = messageInput.value.trim() === '';
        sendButton.title = 'Send message';
    }

    messageInput.addEventListener('input', () => {
        messageInput.style.height = 'auto';
        messageInput.style.height = `${messageInput.scrollHeight}px`;
        if (!isBotGenerating) {
            sendButton.disabled = messageInput.value.trim() === '';
        }
    });

    messageForm.addEventListener('submit', (e) => { 
        e.preventDefault();
        if (isBotGenerating) {
            generationController?.abort();
        } else {
            sendMessage();
        }
    });
    
    // --- MESSAGE HANDLING ---
    function appendMessage(text, role, isStreaming = false) {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `message-wrapper ${role}-message`;

        const icon = document.createElement('div');
        icon.className = 'message-icon';
        icon.innerHTML = `<i class="fa-solid ${role === 'user' ? 'fa-user' : 'fa-robot'}"></i>`;

        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        
        messageWrapper.append(icon, messageContent);
        chatWindow.appendChild(messageWrapper);
        
        if (role === 'bot' && isStreaming) {
            let i = 0;
            const typingSpeed = 20;

            function typing() {
                const isScrolledToBottom = chatWindow.scrollHeight - chatWindow.clientHeight <= chatWindow.scrollTop + 20;
                if (i < text.length) {
                    messageContent.innerHTML += text.charAt(i);
                    i++;
                    if (isScrolledToBottom) {
                        chatWindow.scrollTop = chatWindow.scrollHeight;
                    }
                    setTimeout(typing, typingSpeed);
                } else {
                    processMessageContent(messageContent, text);
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }
            }
            typing();
        } else {
            processMessageContent(messageContent, text);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    }
    
    function processMessageContent(element, rawText) {
        element.innerHTML = marked.parse(rawText, { gfm: false });
        
        element.querySelectorAll('pre').forEach(pre => {
            const code = pre.querySelector('code');
            if (code) {
                hljs.highlightElement(code);
                const header = document.createElement('div');
                header.className = 'code-block-header';
                const langMatch = Array.from(code.classList).find(cls => cls.startsWith('language-'));
                const langName = langMatch ? langMatch.replace('language-', '') : 'code';
                header.innerHTML = `<span class="language-name">${langName}</span><button class="copy-code-btn">Copy</button>`;
                pre.insertBefore(header, code);

                header.querySelector('.copy-code-btn').addEventListener('click', (e) => {
                    const btn = e.target;
                    navigator.clipboard.writeText(code.textContent);
                    btn.textContent = 'Copied!';
                    setTimeout(() => { btn.textContent = 'Copy'; }, 2000);
                });
            }
        });
    }

    function showTypingIndicator() {
        if (document.getElementById('typing-indicator')) return;
        const typingIndicatorHTML = `
            <div class="message-wrapper bot-message" id="typing-indicator">
                <div class="message-icon"><i class="fa-solid fa-robot"></i></div>
                <div class="message-content">
                    <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                </div>
            </div>`;
        chatWindow.insertAdjacentHTML('beforeend', typingIndicatorHTML);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function hideTypingIndicator() {
        document.getElementById('typing-indicator')?.remove();
    }

    async function sendMessage() {
        const userMessage = messageInput.value.trim();
        if (userMessage === '') return;
        
        if (!activeChatId) {
            activeChatId = Date.now().toString();
            allChats[activeChatId] = {
                id: activeChatId,
                title: userMessage.substring(0, 25),
                createdAt: Date.now(),
                messages: []
            };
        }

        allChats[activeChatId].messages.push({ role: 'user', text: userMessage });
        appendMessage(userMessage, 'user');
        
        messageInput.value = '';
        messageInput.style.height = 'auto';
        sendButton.disabled = true;

        showTypingIndicator();
        
        isBotGenerating = true;
        generationController = new AbortController();
        sendButton.innerHTML = '<i class="fa-solid fa-stop"></i>';
        sendButton.classList.add('stop-button');
        sendButton.disabled = false;
        sendButton.title = 'Stop generating';

        try {
            const apiKey = 'YOUR_GOOGLE_AI_API_KEY';

            if (apiKey === 'YOUR_GOOGLE_AI_API_KEY' || !apiKey) {
                hideTypingIndicator();
                appendMessage("Please add your Google AI API Key in the script.", 'bot');
                return;
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModelId}:generateContent?key=${apiKey}`;
            
            const history = allChats[activeChatId].messages.slice(0, -1).map(msg => ({
                role: msg.role === 'bot' ? 'model' : 'user',
                parts: [{ text: msg.text }]
            }));

            const requestBody = {
                contents: [ ...history, { role: "user", parts: [{ text: userMessage }] } ]
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                signal: generationController.signal,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error.message}`);
            }

            const data = await response.json();
            hideTypingIndicator();
            
            if (!data.candidates || data.candidates.length === 0) {
                 appendMessage("I received a response, but it may have been blocked for safety reasons.", 'bot');
                 return;
            }
            const botResponse = data.candidates[0].content.parts[0].text;

            if (botResponse) {
                allChats[activeChatId].messages.push({ role: 'bot', text: botResponse });
                appendMessage(botResponse, 'bot', true);
                saveChatsToStorage();
                renderHistorySidebar();
            } else {
                 appendMessage("Sorry, I could not get a valid response.", 'bot');
            }
        } catch (error) {
            hideTypingIndicator();
            if (error.name === 'AbortError') {
                appendMessage("Generation stopped.", 'bot');
            } else {
                console.error('Error fetching API:', error);
                appendMessage(`An error occurred: ${error.message}`, 'bot');
            }
        } finally {
            resetSendButton();
        }
    }
    
    // --- INITIALIZE APP ---
    function initializeApp() {
        applyTheme(localStorage.getItem('chat-theme') || 'dark');
        loadChatsFromStorage();
        renderHistorySidebar();
        createCustomDropdown();
        startNewChat();
    }

    initializeApp();
});
</script>

</body>
</html>
